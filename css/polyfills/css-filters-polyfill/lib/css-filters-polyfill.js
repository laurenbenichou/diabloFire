/*!
 * css-filters-polyfill.js
 *
 * Author: Christian Schepp Schaefer
 * Summary: A polyfill for CSS filter effects
 * License: MIT
 * Version: 0.3.0
 *
 * URL:
 * https://github.com/Schepp/
 *
 */
!function(e){var t={_ie:function(){for(var e,t=3,r=document.createElement("div"),i=r.getElementsByTagName("i");r.innerHTML="<!--[if gt IE "+ ++t+"]><i></i><![endif]-->",i[0];);return t>4?t:e}(),_svg_cache:{},_create_svg_element:function(e,t){var r="http://www.w3.org/2000/svg",i=document.createElementNS(r,e);for(key in t)i.setAttributeNS(null,key,t[key]);return i},_create_svg:function(e,t){var r="http://www.w3.org/2000/svg",i=document.createElementNS(r,"svg");i.setAttributeNS(null,"width","0"),i.setAttributeNS(null,"height","0"),i.setAttributeNS(null,"style","position:absolute");var s=document.createElementNS(r,"filter");s.setAttributeNS(null,"id",e),i.appendChild(s);for(var n=0;n<t.length;n++)s.appendChild(t[n]);return i},_pending_stylesheets:0,_stylesheets:[],process_stylesheets:function(){var r=[];if(e.setTimeout(function(){if(e.XMLHttpRequest)var t=new XMLHttpRequest;else if(e.ActiveXObject)var t=new ActiveXObject("Microsoft.XMLHTTP");t.open("GET",e.polyfilter_scriptpath+"css-filters-polyfill-parser.js",!0),t.onreadystatechange=function(){4==r.readyState&&200!=r.status&&alert('The configured path \r\rvar polyfilter_scriptpath = "'+e.polyfilter_scriptpath+'"\r\rseems wrong!\r\rConfigure the polyfill\'s correct absolute(!) script path before referencing the css-filters-polyfill.js, like so:\r\rvar polyfilter_scriptpath = "/js/css-filters-polyfill/";\r\rLeaving IE dead in the water is no option. You damn Mac user... ;)')};try{t.send(null)}catch(i){}},2e3),!e.polyfilter_skip_stylesheets){for(var i=document.querySelectorAll?document.querySelectorAll('style,link[rel="stylesheet"]'):document.getElementsByTagName("*"),s=0;s<i.length;s++)!function(r){switch(i[r].nodeName){default:break;case"STYLE":t._stylesheets.push({media:i[r].media||"all",content:i[r].innerHTML});break;case"LINK":if("stylesheet"===i[r].rel){var s=t._stylesheets.length;t._stylesheets.push({media:i[r].media||"all"}),t._pending_stylesheets++;var n=i[r].href;try{if(e.XMLHttpRequest)var l=new XMLHttpRequest;else if(e.ActiveXObject)var l=new ActiveXObject("Microsoft.XMLHTTP");l.open("GET",n,!0),l.onreadystatechange=function(){4===l.readyState&&(0===l.status?(e.console&&console.log("Could not fetch external CSS via HTTP-Request "+n+". Probably because of cross origin limitations. Try turning on CORS headers on the machine serving the stylesheets, like so: https://gist.github.com/Schepp/6338742"),t._stylesheets[s].content||(t._pending_stylesheets--,t._stylesheets[s].content=l.responseText,0===t._pending_stylesheets&&t.process())):t._stylesheets[s].content||(t._pending_stylesheets--,t._stylesheets[s].content=l.responseText,0===t._pending_stylesheets&&t.process()))};try{l.send(null)}catch(a){e.console&&console.log("Could not fetch external CSS via HTTP-Request "+n+". Are you maybe testing using the file://-protocol?"),t._stylesheets[s].content||(t._pending_stylesheets--,0===t._pending_stylesheets&&t.process())}}catch(a){}}}}(s);0===this._pending_stylesheets&&this.process()}},_processDeclarations:function(e){var r="";for(var i in e.declarations){var s=e.declarations[i];if("filter"===s.property){if(document.querySelectorAll)for(var n=document.querySelectorAll(e.mSelectorText),i=0;i<n.length;i++)n[i].style.polyfilterStore=s.valueText;var l=s.valueText,a=l.split(/\)\s+/),o={filtersW3C:[],filtersWebKit:[],filtersSVG:[],filtersIE:[],behaviorsIE:[]};for(idx in a){var f=a[idx]+")";currentproperties=t.convert(f);for(key in currentproperties)"undefined"!=typeof o[key]&&(o[key]=o[key].concat(currentproperties[key]))}if(r+=e.mSelectorText+"{",o.filtersW3C.length>0){webkitFilter=mozFilter=oFilter=msFilter=o.filtersW3C.join(" ");o.filtersWebKit&&o.filtersWebKit.length>0&&(webkitFilter=o.filtersWebKit.join(" ")),"undefined"==typeof this._ie&&(r+="-ms-filter:"+msFilter+";"),r+="-webkit-filter:"+webkitFilter+";",r+="-moz-filter:"+mozFilter+";",r+="-o-filter:"+oFilter+";"}if(o.filtersSVG.length>0)if("none"!=o.filtersSVG[0]){var c=l.replace(/[^a-z0-9]/g,"");if("undefined"==typeof this._svg_cache[c])if(this._svg_cache[c]=this._create_svg(c,o.filtersSVG),"undefined"==typeof XMLSerializer)document.body.appendChild(this._svg_cache[c]);else{var h=new XMLSerializer,p=h.serializeToString(this._svg_cache[c]);-1!=p.search("SourceGraphic")&&document.body.appendChild(this._svg_cache[c])}if("undefined"==typeof XMLSerializer)r+="filter: url(#"+c+")";else{var h=new XMLSerializer,p=h.serializeToString(this._svg_cache[c]);r+=-1!=p.search("SourceGraphic")?"filter: url(#"+c+")":"filter: url('data:image/svg+xml;utf8,"+p+"#"+c+"')"}}else r+="filter: none;";if("undefined"!=typeof this._ie){if(o.filtersIE.length>0){var u=o.filtersIE.join(" ");r+="filter:"+u+";"}if(o.behaviorsIE.length>0){var d=o.behaviorsIE.join(" ");r+="behavior:"+d+";"}}r+="}\r\n"}}return r},scriptpath:e.polyfilter_scriptpath?e.polyfilter_scriptpath:function(){return alert('Please configure the polyfill\'s absolute(!) script path before referencing the css-filters-polyfill.js, like so:\r\nvar polyfilter_scriptpath = "/js/css-filters-polyfill/";'),"./"}(),process:function(){if(e.Worker){var r=new Worker(this.scriptpath+"css-filters-polyfill-parser.js");r.addEventListener("message",function(e){t.create(e.data.content,e.data.media)},!1)}else var i=new CSSParser;for(var s=0;s<this._stylesheets.length;s++)if(e.Worker)r.postMessage(this._stylesheets[s]);else{var n=i.parse(this._stylesheets[s].content,!1,!0);this.create(n,this._stylesheets[s].media)}},create:function(e,r){var i="";if(null!==e)for(var s in e.cssRules){var n=e.cssRules[s];switch(n.type){default:break;case 1:i+=this._processDeclarations(n);break;case 4:i+="@media "+n.media.join(",")+"{";for(var l in n.cssRules){var a=n.cssRules[l];i+=this._processDeclarations(a)}i+="}"}}var o=document.createElement("style");o.setAttribute("media",r),"undefined"==typeof t._ie?(o.innerHTML=i,document.getElementsByTagName("head")[0].appendChild(o)):(document.getElementsByTagName("head")[0].appendChild(o),o.styleSheet.cssText=i)},init:function(){Object.defineProperty&&Object.defineProperty(CSSStyleDeclaration.prototype,"polyfilter",{get:function(){return this.polyfilterStore},set:function(e){values=e.split(/\)\s+/);var r={filtersW3C:[],filtersWebKit:[],filtersSVG:[],filtersIE:[],behaviorsIE:[]};for(idx in values){var i=values[idx]+")";currentproperties=t.convert(i);for(key in currentproperties)"undefined"!=typeof r[key]&&(r[key]=r[key].concat(currentproperties[key]))}if(r.filtersW3C.length>0&&("undefined"==typeof t._ie&&(this.msFilter=r.filtersW3C.join(" ")),this.webkitFilter=this.mozFilter=this.oFilter=r.filtersW3C.join(" ")),r.filtersWebKit.length>0&&(this.webkitFilter=r.filtersWebKit.join(" ")),r.filtersSVG.length>0)if("none"!=r.filtersSVG[0]){var s=e.replace(/[^a-z0-9]/g,"");if("undefined"==typeof t._svg_cache[s])if(t._svg_cache[s]=t._create_svg(s,r.filtersSVG),"undefined"==typeof XMLSerializer)document.body.appendChild(t._svg_cache[s]);else{var n=new XMLSerializer,l=n.serializeToString(t._svg_cache[s]);-1!=l.search("SourceGraphic")&&document.body.appendChild(t._svg_cache[s])}if("undefined"==typeof XMLSerializer)this.filter="url(#"+s+")";else{var n=new XMLSerializer,l=n.serializeToString(t._svg_cache[s]);-1!=l.search("SourceGraphic")?this.filter="url(#"+s+")":this.filter="url('data:image/svg+xml;utf8,"+l+"#"+s+"')"}}else this.filter="none";"undefined"!=typeof t._ie&&(r.filtersIE.length>0?this.filter=r.filtersIE.join(" "):this.filter="",r.behaviorsIE.length>0?this.behavior=r.behaviorsIE.join(" "):this.behavior=""),this.polyfilterStore=e}})},convert:function(e){var t=e.match(/none/i);if(null!==t)var r=this.filters.none();var t=e.match(/(grayscale)\(([0-9\.]+)\)/i);if(null!==t)var i=parseFloat(t[2],10),r=this.filters.grayscale(i);var t=e.match(/(sepia)\(([0-9\.]+)\)/i);if(null!==t)var i=parseFloat(t[2],10),r=this.filters.sepia(i);var t=e.match(/(blur)\(([0-9]+)[px]*\)/i);if(null!==t)var i=parseInt(t[2],10),r=this.filters.blur(i);var t=e.match(/(invert)\(([0-9\.]+)\)/i);if(null!==t)var i=parseFloat(t[2],10),r=this.filters.invert(i);var t=e.match(/(brightness)\(([0-9\.]+)%\)/i);if(null!==t)var i=parseFloat(t[2],10),r=this.filters.brightness(i);var t=e.match(/(saturate)\(([0-9\.]+)%\)/i);if(null!==t)var i=parseFloat(t[2],10),r=this.filters.saturate(i);var t=e.match(/(hue-rotate)\(([0-9\.]+)deg\)/i);if(null!==t)var i=parseFloat(t[2],10),r=this.filters.hueRotate(i);var t=e.match(/(drop\-shadow)\(([0-9]+)[px]*\s+([0-9]+)[px]*\s+([0-9]+)[px]*\s+([#0-9]+)\)/i);if(null!==t)var s=parseInt(t[2],10),n=parseInt(t[3],10),l=parseInt(t[4],10),a=t[5],r=this.filters.dropShadow(s,n,l,a);return r},filters:{none:function(){var e={};return"undefined"==typeof t._ie?(e.filtersW3C=["none"],e.filtersSVG=["none"]):e.filtersIE=["none"],e},grayscale:function(e){e=e||0;var r={};if("undefined"==typeof t._ie){r.filtersW3C=["grayscale("+e+")"];var i=t._create_svg_element("feColorMatrix",{type:"matrix",values:.2126+.7874*(1-e)+" "+(.7152-.7152*(1-e))+" "+(.0722-.0722*(1-e))+" 0 0 "+(.2126-.2126*(1-e))+" "+(.7152+.2848*(1-e))+" "+(.0722-.0722*(1-e))+" 0 0 "+(.2126-.2126*(1-e))+" "+(.7152-.7152*(1-e))+" "+(.0722+.9278*(1-e))+" 0 0 0 0 0 1 0"});r.filtersSVG=[i]}else r.filtersIE=e>=.5?["gray"]:[];return r},sepia:function(e){e=e||0;var r={};if("undefined"==typeof t._ie){r.filtersW3C=["sepia("+e+")"];var i=t._create_svg_element("feColorMatrix",{type:"matrix",values:.393+.607*(1-e)+" "+(.769-.769*(1-e))+" "+(.189-.189*(1-e))+" 0 0 "+(.349-.349*(1-e))+" "+(.686+.314*(1-e))+" "+(.168-.168*(1-e))+" 0 0 "+(.272-.272*(1-e))+" "+(.534-.534*(1-e))+" "+(.131+.869*(1-e))+" 0 0 0 0 0 1 0"});r.filtersSVG=[i]}else r.filtersIE=e>=.5?["gray","progid:DXImageTransform.Microsoft.Light()"]:[],r.behaviorsIE=e>=.5?['url("'+t.scriptpath+'htc/sepia.htc")']:[];return r},blur:function(e){e=Math.round(e)||0;var r={};if("undefined"==typeof t._ie){r.filtersW3C=["blur("+e+"px)"];var i=t._create_svg_element("feGaussianBlur",{"in":"SourceGraphic",stdDeviation:e});r.filtersSVG=[i]}else r.filtersIE=["progid:DXImageTransform.Microsoft.Blur(pixelradius="+e+")"];return r},invert:function(e){e=e||0;var r={};if("undefined"==typeof t._ie){r.filtersW3C=["invert("+e+")"];var i=t._create_svg_element("feComponentTransfer",{"color-interpolation-filters":"sRGB"}),s=t._create_svg_element("feFuncR",{type:"table",tableValues:e+" "+(1-e)});i.appendChild(s);var s=t._create_svg_element("feFuncG",{type:"table",tableValues:e+" "+(1-e)});i.appendChild(s);var s=t._create_svg_element("feFuncB",{type:"table",tableValues:e+" "+(1-e)});i.appendChild(s),r.filtersSVG=[i]}else r.filtersIE=e>=.5?["invert"]:[];return r},brightness:function(e){e=e||0;var r={};if("undefined"==typeof t._ie){r.filtersW3C=["brightness("+e+"%)"];var i=t._create_svg_element("feComponentTransfer",{"color-interpolation-filters":"sRGB"}),s=t._create_svg_element("feFuncR",{type:"linear",slope:e/100});i.appendChild(s);var s=t._create_svg_element("feFuncG",{type:"linear",slope:e/100});i.appendChild(s);var s=t._create_svg_element("feFuncB",{type:"linear",slope:e/100});i.appendChild(s),r.filtersSVG=[i]}else r.filtersIE=["progid:DXImageTransform.Microsoft.Light()"],r.behaviorsIE=['url("'+t.scriptpath+'htc/brightness.htc")'];return r},saturate:function(e){e=e||0;var r={};if("undefined"==typeof t._ie){r.filtersW3C=["saturate("+e+"%)"];var i=t._create_svg_element("feColorMatrix",{type:"saturate",values:e/100});r.filtersSVG=[i]}return r},hueRotate:function(e){e=e||0;var r={};if("undefined"==typeof t._ie){r.filtersW3C=["hue-rotate("+e+"deg)"];var i=t._create_svg_element("feColorMatrix",{type:"hueRotate",values:e});r.filtersSVG=[i]}return r},dropShadow:function(e,r,i,s){e=Math.round(e)||0,r=Math.round(r)||0,i=Math.round(i)||0,s=s||"#000000";var n={};if("undefined"==typeof t._ie){n.filtersW3C=["drop-shadow("+e+"px "+r+"px "+i+"px "+s+")"];var l=t._create_svg_element("feGaussianBlur",{"in":"SourceAlpha",stdDeviation:i}),a=t._create_svg_element("feOffset",{dx:e+1,dy:r+1,result:"offsetblur"}),o=t._create_svg_element("feFlood",{"flood-color":s}),f=t._create_svg_element("feComposite",{in2:"offsetblur",operator:"in"}),c=t._create_svg_element("feMerge",{}),h=t._create_svg_element("feMergeNode",{});c.appendChild(h);var h=t._create_svg_element("feMergeNode",{"in":"SourceGraphic"});c.appendChild(h),n.filtersSVG=[l,a,o,f,c]}else n.filtersIE=["progid:DXImageTransform.Microsoft.Glow(color="+s+",strength=0)","progid:DXImageTransform.Microsoft.Shadow(color="+s+",strength=0)"],n.behaviorsIE=['url("'+t.scriptpath+'htc/drop-shadow.htc")'];return n}}};e.jQuery?e.jQuery(document).ready(function(e){t.process_stylesheets()}):e.contentLoaded?contentLoaded(e,function(){t.process_stylesheets()}):e.addEventListener?document.addEventListener("DOMContentLoaded",function(){t.process_stylesheets()},!1):e.attachEvent&&e.attachEvent("onload",function(){t.process_stylesheets()}),t.init()}(window);